Configuration Reference
=======================

The BlockBundle can be configured under the ``cmf_block`` key in your
application configuration. When using XML, you can use the
``http://cmf.symfony.com/schema/dic/block`` namespace.

The BlockBundle *automatically* changes some defaults and adds configuration
to the SonataBlockBundle to make the integration work seamlessly. See the
:ref:`updated SonataBlockBundle defaults <bundles-block-updated-sonata-defaults>`
for more information.

Configuration
-------------

.. _reference-config-block-persistence:

``persistence``
~~~~~~~~~~~~~~~

``phpcr``
.........

This defines the persistence driver. The default configuration of persistence
is the following configuration:

.. configuration-block::

    .. code-block:: yaml

        cmf_block:
            persistence:
                phpcr:
                    enabled:                  false
                    block_basepath:           /cms/content
                    manager_name:             ~

    .. code-block:: xml

        <?xml version="1.0" charset="UTF-8" ?>
        <container xmlns="http://symfony.com/schema/dic/services">

            <config xmlns="http://cmf.symfony.com/schema/dic/block">
                <persistence>
                    <phpcr
                        enabled="false"
                        block-basepath="/cms/content"
                        manager-name="null"
                    />
                </persistence>
            </config>

        </container>

    .. code-block:: php

        $container->loadFromExtension('cmf_block', array(
            'persistence' => array(
                'phpcr' => array(
                    'enabled'                  => false,
                    'block-basepath'           => '/cms/content',
                    'manager_name'             => null,
                ),
            ),
        ));


``enabled``
"""""""""""

.. include:: ../_partials/persistence_phpcr_enabled.rst.inc

``block_basepath``
""""""""""""""""""

**type**: ``string`` **default**: ``/cms/content``

The basepath for blocks in the PHPCR tree.

If the :doc:`CoreBundle <../core/introduction>` is registered, this will default to
the value of ``%cmf_core.persistence.phpcr.basepath%/content``.

``manager_name``
""""""""""""""""

.. include:: ../_partials/persistence_phpcr_manager_name.rst.inc

``twig``
~~~~~~~~

.. _reference-config-block-twig-cmf-embed-blocks:

``cmf_embed_blocks``
....................

The BlockBundle provides a Twig filter ``cmf_embed_blocks`` that
looks through the content and looks for special tags to render blocks.

See :ref:`embed blocks in content <bundles-block-embed>` for using the
``cmf_embed_blocks`` filter.

``prefix``
""""""""""

**type**: ``string`` **default**: ``%embed-block|``

The part before the actual path to the block.

``postfix``
"""""""""""

**type**: ``string`` **default**: ``|end%``

The part after the actual path to the block.

``caches``
~~~~~~~~~~

The BlockBundle integrates with the `SonataCacheBundle`_ to provide several
caching solutions.

.. _reference-config-block-caches-esi:

``varnish``
...........

This extends the default VarnishCache adapter of the SonataCacheBundle.

.. configuration-block::

    .. code-block:: yaml

        # app/config/config.yml
        framework:
            # ...
            esi: { enabled: true }
            # enable FragmentListener to automatically validate and secure fragments
            fragments: { path: /_fragment }
            # add varnish server ip-address(es)
            trusted_proxies: [192.0.0.1, 10.0.0.0/8]

        cmf_block:
            # ...
            caches:
                varnish:
                    token: a unique security key # a random one is generated by default
                    servers:
                        - varnishadm -T 127.0.0.1:2000 {{ COMMAND }} "{{ EXPRESSION }}"

    .. code-block:: xml

        <!-- app/config/config.xml -->
        <?xml version="1.0" encoding="UTF-8" ?>
        <container xmlns="http://symfony.com/schema/dic/services">

            <config xmlns="http://cmf.symfony.com/schema/dic/block">
                <caches>
                    <!-- token: a random one is generated by default -->
                    <varnish token="a unique security key">
                        <server>varnishadm -T 127.0.0.1:2000 {{ COMMAND }} "{{ EXPRESSION }}"</server>
                    </varnish>
                </caches>
            </config>

        </container>

    .. code-block:: php

        // app/config/config.php
        $container->loadFromExtension('cmf_block', array(
            // ...
            'caches' => array(
                'varnish' => array(
                    'token' => 'a unique security key', // a random one is generated by default
                    'servers' => array(
                        'varnishadm -T 127.0.0.1:2000 {{ COMMAND }} "{{ EXPRESSION }}"',
                    ),
                ),
            ),
        ));

``token``
"""""""""

**type**: ``string`` **default**: ``hash('sha256', uniqid(mt_rand(), true))``

A unique secret key. A random one is generated by default.

``servers``
"""""""""""

**type**: ``array``

.. _reference-config-block-caches-ssi:

``ssi``
.......

This extends the default SsiCache adapter of the SonataCacheBundle.

.. configuration-block::

    .. code-block:: yaml

        # app/config/config.yml
        cmf_block:
            # ...
            caches:
                ssi:
                   token: a unique security key # a random one is generated by default

    .. code-block:: xml

        <!-- app/config/config.xml -->
        <?xml version="1.0" encoding="UTF-8" ?>
        <container xmlns="http://symfony.com/schema/dic/services">

            <config xmlns="http://cmf.symfony.com/schema/dic/block">
                <caches>
                    <!-- token: a random one is generated by default -->
                    <ssi
                        token="a unique security key"
                    />
                </caches>
            </config>

        </container>

    .. code-block:: php

        // app/config/config.php
        $container->loadFromExtension('cmf_block', array(
            // ...
            'caches' => array(
                'ssi' => array(
                    'token' => 'a unique security key', // a random one is generated by default
                ),
            ),
        ));

``token``
"""""""""

**type**: ``string`` **default**: ``hash('sha256', uniqid(mt_rand(), true))``

A unique secret key. A random one is generated by default.

.. _`SonataCacheBundle`: https://github.com/sonata-project/SonataCacheBundle

